import unittest
from unittest.mock import MagicMock, patch
from g9_driver import G9Driver

# Optional Data modified to throw no errors
msg = b'@\x00\x00\xc3\x00\x00\xcb\x00\x00\x00\x00\x00\x08\x00\x00\x1f\xffC\x00\x1f\xff\xff\xff\x0f\x00\x1f\xff\xff\x00\x1f\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x01\x9a\x08\xbe\x14\x00\x0020000012X17M\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\n\n?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb2?\x00\x14\xac?\x00\x14\xac?\x00\x14\xac?\x00\x14\xa0?\x00\x14\xa0\x06\x00\x14\xb2\x01\x00\x14\xb2\x01\x00\x14\xb2\x01\x00\x14\xb2\x06\x00\x14\xb2\x01\x00\x14\xb2\x06\x00\x14\x9a\x01\x00\x14\x9a\x01\x00\x14\x9a\x06\x00\x14\x9a\x1a\xe8*\r'

class TestG9Driver(unittest.TestCase):
    
    def setUp(self):
        self.driver = G9Driver()
        self.driver.msgOptData = b'\x00\x00\x00\x00'
        self.driver.ser = MagicMock()

    # Modified bytes msg[73:75] to ['02', '00'] to trigger a power supply error within unit status bytes
    def test_unit_state_error(self):
        msg3 = b'@\x00\x00\xc3\x00\x00\xcb\x00\x00\x00\x00\x00\x08\x00\x00\x1f\xffC\x00\x1f\xff\xff\xff\x0f\x00\x1f\xff\xff\x00\x1f\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x02\x00\x9a\x08\xbe\x14\x00\x0020000012X17M\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\n\n?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb2?\x00\x14\xac?\x00\x14\xac?\x00\x14\xac?\x00\x14\xa0?\x00\x14\xa0\x06\x00\x14\xb2\x01\x00\x14\xb2\x01\x00\x14\xb2\x01\x00\x14\xb2\x06\x00\x14\xb2\x01\x00\x14\xb2\x06\x00\x14\x9a\x01\x00\x14\x9a\x01\x00\x14\x9a\x06\x00\x14\x9a\x1a\xe8*\r'
        self.driver.ser.read_until.return_value = msg3
        
        with self.assertRaises(ValueError) as context:
            self.driver.response()

        self.assertIn("Output Power Supply Error Flag (bit 9)", str(context.exception))

    # changed 10 to \x00 instead of expected \xff
    def test_input_error(self):
        msg2 = b'@\x00\x00\xc3\x00\x00\xcb\x00\x00\x00\x00\x00\x08\x00\x00\x1f\x00C\x00\x1f\xff\xff\xff\x0f\x00\x1f\xff\xff\x00\x1f\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x01\x9a\x08\xbe\x14\x00\x0020000012X17M\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\n\n?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb2?\x00\x14\xac?\x00\x14\xac?\x00\x14\xac?\x00\x14\xa0?\x00\x14\xa0\x06\x00\x14\xb2\x01\x00\x14\xb2\x01\x00\x14\xb2\x01\x00\x14\xb2\x06\x00\x14\xb2\x01\x00\x14\xb2\x06\x00\x14\x9a\x01\x00\x14\x9a\x01\x00\x14\x9a\x06\x00\x14\x9a\x1a\xe8*\r'
        self.driver.ser.read_until.return_value = msg2

        with self.assertRaises(ValueError) as context:
            self.driver.response()

        self.assertIn("An input is either off or throwing an error", str(context.exception))

    # changed byte 20 to be \x00 instead of expected \xff
    def test_output_error(self):
        msg1 = b'@\x00\x00\xc3\x00\x00\xcb\x00\x00\x00\x00\x00\x08\x00\x00\x1f\xffC\x00\x1f\x00\x00\xff\x0f\x00\x1f\xff\xff\x00\x1f\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x01\x9a\x08\xbe\x14\x00\x0020000012X17M\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\n\n?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb8?\x00\x14\xb2?\x00\x14\xac?\x00\x14\xac?\x00\x14\xac?\x00\x14\xa0?\x00\x14\xa0\x06\x00\x14\xb2\x01\x00\x14\xb2\x01\x00\x14\xb2\x01\x00\x14\xb2\x06\x00\x14\xb2\x01\x00\x14\xb2\x06\x00\x14\x9a\x01\x00\x14\x9a\x01\x00\x14\x9a\x06\x00\x14\x9a\x1a\xe8*\r'
        self.driver.ser.read_until.return_value = msg1

        with self.assertRaises(ValueError) as context:
            self.driver.response()

        self.assertIn("There is output(s) off", str(context.exception))


    # test of normal excepted values
    def test_no_error(self):
        self.driver.ser.read_until.return_value = msg

        try:
            self.driver.response()
        except ValueError:
            self.fail("response() raised ValueError unexpectedly")

if __name__ == '__main__':
    unittest.main()
